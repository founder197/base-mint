<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>NFT Marketplace</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
</head>
<body>
  <h2>NFT Marketplace</h2>
  <button id="connect">Conectar Wallet</button>
  <div id="account"></div>

  <h3>Listar NFT</h3>
  <input id="nftAddress" placeholder="Endereço do NFT (ERC721)"/>
  <input id="tokenId" placeholder="Token ID"/>
  <input id="price" placeholder="Preço em ETH"/>
  <button id="list">Listar</button>

  <h3>Market Items</h3>
  <button id="refresh">Atualizar</button>
  <ul id="items"></ul>

  <script>
    const MARKETPLACE_ADDRESS = "0x__SEU_MARKETPLACE_ADDRESS__"; // substituir após deploy
    const MARKETPLACE_ABI = [
      "function listItem(address nftAddress,uint256 tokenId,uint256 price) external",
      "function buyItem(uint256 itemId) external payable",
      "function fetchMarketItems() view returns (tuple(uint256 itemId,address nftAddress,uint256 tokenId,address seller,uint256 price,bool sold)[])",
      "function cancelListing(uint256 itemId) external"
    ];
    const ERC721_ABI = [
      "function approve(address to, uint256 tokenId) external",
      "function ownerOf(uint256 tokenId) view returns (address)"
    ];

    let provider, signer, signerAddress;
    const connectBtn = document.getElementById('connect');
    const accountDiv = document.getElementById('account');

    async function connect() {
      if (!window.ethereum) return alert("Instale MetaMask");
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      signerAddress = await signer.getAddress();
      accountDiv.innerText = "Conta: " + signerAddress;
    }
    connectBtn.onclick = connect;

    async function listNFT() {
      const nftAddress = document.getElementById('nftAddress').value;
      const tokenId = document.getElementById('tokenId').value;
      const priceEth = document.getElementById('price').value;
      if (!nftAddress || !tokenId || !priceEth) return alert("Preencha campos");

      const nftContract = new ethers.Contract(nftAddress, ERC721_ABI, signer);
      const marketplace = new ethers.Contract(MARKETPLACE_ADDRESS, MARKETPLACE_ABI, signer);

      // approve marketplace to transfer token
      const approveTx = await nftContract.approve(MARKETPLACE_ADDRESS, tokenId);
      await approveTx.wait();

      const priceWei = ethers.utils.parseEther(priceEth);
      const tx = await marketplace.listItem(nftAddress, tokenId, priceWei);
      await tx.wait();
      alert("NFT listado");
    }
    document.getElementById('list').onclick = listNFT;

    async function loadItems() {
      if (!provider) {
        document.getElementById('items').innerHTML = "<li>Conecte wallet</li>";
        return;
      }
      const marketplace = new ethers.Contract(MARKETPLACE_ADDRESS, MARKETPLACE_ABI, provider);
      const items = await marketplace.fetchMarketItems();
      const list = document.getElementById('items');
      list.innerHTML = "";
      for (const it of items) {
        const li = document.createElement('li');
        const priceEth = ethers.utils.formatEther(it.price.toString());
        li.innerHTML = `Item ${it.itemId} - NFT: ${it.nftAddress} #${it.tokenId} - Seller: ${it.seller} - Price: ${priceEth} ETH
          <button data-id="${it.itemId}" class="buy">Comprar</button>`;
        list.appendChild(li);
      }
      document.querySelectorAll('.buy').forEach(btn => {
        btn.onclick = async (e) => {
          const id = e.target.getAttribute('data-id');
          await buyItem(id);
        };
      });
    }
    document.getElementById('refresh').onclick = loadItems;

    async function buyItem(itemId) {
      const marketplace = new ethers.Contract(MARKETPLACE_ADDRESS, MARKETPLACE_ABI, signer);
      // fetch to know price
      const items = await marketplace.fetchMarketItems();
      const item = items.find(i => i.itemId.toString() === itemId.toString());
      if (!item) return alert("Item não encontrado");
      const price = item.price.toString();
      const tx = await marketplace.buyItem(itemId, { value: price });
      await tx.wait();
      alert("Compra concluída");
      loadItems();
    }
  </script>
</body>
</html>