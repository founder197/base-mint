<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mint Real ‚Äî Single File</title>

<!-- tailwind (visual r√°pido) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- ethers v6 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js"></script>

<style>
  body{height:100%;background:linear-gradient(135deg,#0f172a,#6d28d9);color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .card{max-width:720px;margin:40px auto;padding:24px;background:rgba(255,255,255,0.05);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,0.4)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Roboto Mono,monospace}
  a.small{font-size:13px;color:#c7b3ff}
</style>
</head>
<body>
  <div class="card">
    <h1 class="text-2xl font-bold">Mint Real (Single File)</h1>
    <p class="text-sm mt-1 opacity-90">Conecte carteira ‚Üí envie imagem ‚Üí mint no contrato ERC-721 (fun√ß√£o <span class="mono">mintNFT(string)</span>).</p>

    <!-- conex√£o -->
    <div class="mt-4">
      <button id="btnConnect" class="px-4 py-2 bg-blue-600 rounded-lg font-semibold">üîå Conectar Carteira</button>
      <div id="wallet" class="mt-2 text-sm mono"></div>
    </div>

    <!-- contrato -->
    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
      <div>
        <label class="block text-xs opacity-80">Endere√ßo do contrato (ERC-721)</label>
        <input id="contractAddress" class="w-full mt-1 p-2 rounded bg-white/5 mono" placeholder="0x.. (se vazio, ser√° necess√°rio inserir)" />
      </div>
      <div>
        <label class="block text-xs opacity-80">Nome do token (opcional)</label>
        <input id="tokenName" class="w-full mt-1 p-2 rounded bg-white/5" placeholder="Ex: MeuNFT" />
      </div>
    </div>

    <!-- upload -->
    <div class="mt-4">
      <label class="block text-sm mb-1">Escolha uma imagem</label>
      <input id="fileInput" type="file" accept="image/*" class="w-full p-2 rounded bg-white/5"/>
    </div>

    <!-- bot√µes -->
    <div class="mt-4 flex gap-2">
      <button id="btnPrepare" class="flex-1 px-4 py-2 bg-emerald-600 rounded-lg">üì§ Preparar metadata</button>
      <button id="btnMint" class="flex-1 px-4 py-2 bg-purple-600 rounded-lg">ü™Ñ Mint (on-chain)</button>
    </div>

    <div id="status" class="mt-4 text-sm"></div>
    <div id="result" class="mt-3 text-sm"></div>

    <p class="mt-4 text-xs opacity-80">Obs: tokenURI ser√° um <span class="mono">data:application/json;base64,</span> com a imagem embutida (base64). N√£o h√° upload externo.</p>
  </div>

<script>
(async ()=> {
  // ---------- Configura√ß√£o ----------
  // ABI m√≠nima esperada:
  const ERC721_MIN_ABI = [
    // fun√ß√£o que usaremos: mintNFT(string memory tokenURI)
    "function mintNFT(string memory tokenURI) public"
  ];

  // ---------- Estado ----------
  let provider = null;
  let signer = null;
  let address = null;
  let prepared = null; // { tokenURI, metadata, imageName }

  // ---------- helpers ----------
  const $ = id => document.getElementById(id);
  const setStatus = (html) => { $('status').innerHTML = html; console.log(html); }
  const setResult = (html) => { $('result').innerHTML = html; console.log(html); }

  // ---------- conectar carteira (injetada) ----------
  async function connectWallet(){
    try{
      setStatus('üîç Iniciando conex√£o com carteira...');
      if(!window.ethereum) {
        setStatus('‚ö†Ô∏è Nenhuma carteira injetada (abra este link no navegador de sua carteira, ex: MetaMask mobile, Coinbase, Trust etc.).');
        return;
      }
      // pede permiss√£o
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      address = await signer.getAddress();
      const net = await provider.getNetwork();
      $('wallet').innerHTML = `üîê ${address.slice(0,6)}...${address.slice(-4)} ‚Ä¢ ${net.name}`;
      setStatus('‚úÖ Carteira conectada.');
    } catch(e){
      console.error(e);
      if(e.code === 4001) setStatus('‚ùå Conex√£o rejeitada pelo usu√°rio.');
      else setStatus('‚ùå Erro ao conectar carteira.');
    }
  }
  $('btnConnect').addEventListener('click', connectWallet);

  // ---------- ler arquivo e gerar data-uri base64  ----------
  function fileToBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result; // data:<type>;base64,...
        resolve(dataUrl);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ---------- preparar metadata (gera data:application/json;base64,...) ----------
  $('btnPrepare').addEventListener('click', async ()=>{
    try{
      const file = $('fileInput').files[0];
      if(!file) { alert('Escolha uma imagem primeiro'); return; }
      setStatus('‚è≥ Lendo arquivo e gerando metadata (local)...');
      const imgDataUrl = await fileToBase64(file); // ex: data:image/png;base64,AAA...
      // metadata simples
      const name = $('tokenName').value || file.name || 'My NFT';
      const metadata = {
        name,
        description: `Minted by single-file UI ‚Äî ${name}`,
        image: imgDataUrl,
        created_at: new Date().toISOString()
      };
      const metaJson = JSON.stringify(metadata);
      const b64 = btoa(unescape(encodeURIComponent(metaJson))); // base64
      const tokenURI = `data:application/json;base64,${b64}`;
      prepared = { tokenURI, metadata, imageName: file.name };
      setStatus('‚úÖ Metadata preparado (local). Pronto para mint.');
      setResult(`<div>üîé Preview metadata:<pre style="white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px">${JSON.stringify(metadata,null,2)}</pre></div>`);
    }catch(err){
      console.error(err);
      setStatus('‚ùå Erro ao preparar metadata: ' + (err.message||err));
    }
  });

  // ---------- mint on-chain ----------
  $('btnMint').addEventListener('click', async ()=>{
    try{
      if(!prepared) {
        const ok = confirm('Metadata n√£o preparado. Deseja preparar automaticamente agora?');
        if(ok) { $('btnPrepare').click(); await new Promise(r=>setTimeout(r,600)); } else return;
      }
      if(!prepared) { setStatus('‚ùå N√£o foi poss√≠vel preparar metadata.'); return; }
      // ensure connected
      if(!signer) {
        const doConnect = confirm('Carteira n√£o conectada. Deseja conectar agora?');
        if(!doConnect) return;
        await connectWallet();
        if(!signer) return;
      }

      // get contract address input
      const contractAddress = ($('contractAddress').value || '').trim();
      if(!contractAddress) {
        alert('Insira o endere√ßo do contrato ERC-721 com fun√ß√£o public mintNFT(string).');
        return;
      }

      setStatus('üîê Preparando transa√ß√£o de mint ‚Äî confirme na sua carteira.');
      // create contract and call
      const contract = new ethers.Contract(contractAddress, ERC721_MIN_ABI, signer);
      // call mintNFT(tokenURI)
      const tx = await contract.mintNFT(prepared.tokenURI);
      setStatus(`‚è≥ Transa√ß√£o enviada: ${tx.hash}. Aguardando confirma√ß√£o...`);
      setResult(`<div>üîó Tx enviada: <a class="small" target="_blank" href="#">${tx.hash}</a></div>`);
      await tx.wait();
      setStatus(`‚úÖ Mint conclu√≠do! Tx: ${tx.hash}`);
      // optional: show etherscan link for common networks
      try {
        const net = await provider.getNetwork();
        let explorer = null;
        if(net.chainId === 1) explorer = `https://etherscan.io/tx/${tx.hash}`;
        else if(net.chainId === 8453) explorer = `https://basescan.org/tx/${tx.hash}`;
        else if(net.chainId === 137) explorer = `https://polygonscan.com/tx/${tx.hash}`;
        else if(net.chainId === 56) explorer = `https://bscscan.com/tx/${tx.hash}`;
        if(explorer) setResult(`<div>üîó Tx confirmada: <a class="small" target="_blank" href="${explorer}">${explorer}</a></div>`);
      } catch(e){ console.warn(e); }
    }catch(err){
      console.error(err);
      setStatus('‚ùå Erro durante o mint: ' + (err.message||err));
    }
  });

  // quick hint if mobile in-wallet
  if(window.ethereum && window.ethereum.isMetaMask) {
    // nothing
  } else if(window.ethereum) {
    // other injected
  } else {
    // no injected - we still allow the user to paste a contract and use WalletConnect later (not included)
  }

})();
</script>
</body>
</html>