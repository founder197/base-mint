<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Minter Simples</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        button { padding: 10px 15px; margin: 5px 0; cursor: pointer; }
        #status { margin-top: 20px; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; word-break: break-all; }
        #nft-preview { max-width: 100%; height: auto; margin-top: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>
    <h1>Mint NFT com Data URI</h1>

    <h2>Configura√ß√£o</h2>
    <p>Preencha estas constantes no script para come√ßar a usar.</p>

    <h2>1. Conex√£o</h2>
    <button id="connectWalletBtn">Conectar Carteira</button>
    <p id="walletAddressStatus">Status: Desconectado</p>
    
    <h2>2. Metadados e Imagem</h2>
    <input type="text" id="nftName" placeholder="Nome do NFT (Ex: Gato Teste)">
    <input type="text" id="nftDescription" placeholder="Descri√ß√£o do NFT">
    <input type="file" id="imageUpload" accept="image/*">
    <button id="previewBtn">Visualizar NFT</button>
    <img id="nft-preview" src="" alt="Pr√©via do NFT" style="display: none;">

    <h2>3. Mint</h2>
    <button id="mintBtn" disabled>Mintar NFT</button>

    <h2>Status da Transa√ß√£o</h2>
    <div id="status">Pronto para come√ßar.</div>

    <script>
        // =========================================================
        // üö® PASSOS OBRIGAT√ìRIOS: PREENCHA ESTAS DUAS CONSTANTES üö®
        // =========================================================
        const CONTRACT_ADDRESS = "COLE_AQUI_O_ENDERECO_DO_SEU_CONTRATO_IMPLANTADO"; 
        // Exemplo: "0xABC...123"
        
        // ABI M√çNIMA: Apenas o construtor e a fun√ß√£o que queremos chamar.
        const CONTRACT_ABI = [
            // Apenas a fun√ß√£o que o nosso contrato implementa: mintNFT(string memory tokenURI)
            "function mintNFT(string memory tokenURI)",
        ];
        // =========================================================

        let signer;
        let contract;
        let dataUriCache = ''; // Armazenar a Data URI gerada para o Mint

        const statusDiv = document.getElementById('status');
        const walletAddressStatus = document.getElementById('walletAddressStatus');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const previewBtn = document.getElementById('previewBtn');
        const mintBtn = document.getElementById('mintBtn');
        const nftPreview = document.getElementById('nft-preview');

        /**
         * 1. CONECTAR CARTEIRA
         */
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                updateStatus("üö® MetaMask n√£o est√° instalada. Instale para prosseguir.");
                return;
            }

            try {
                // Solicita a conex√£o com a MetaMask
                const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                await provider.send("eth_requestAccounts", []);
                
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                // Inicializa o objeto de contrato
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                walletAddressStatus.textContent = `Status: Conectado como ${address.substring(0, 6)}...${address.substring(38)}`;
                connectWalletBtn.disabled = true;
                mintBtn.disabled = false;
                
                updateStatus("‚úÖ Carteira conectada e contrato inicializado.");

            } catch (error) {
                updateStatus(`‚ùå Erro ao conectar: ${error.message}`);
                console.error(error);
            }
        }

        /**
         * 2. GERAR DATA URI (Metadados + Imagem embutida)
         */
        function generateDataURI(base64Image) {
            const name = document.getElementById('nftName').value;
            const description = document.getElementById('nftDescription').value;

            if (!name || !description || !base64Image) {
                updateStatus("üö® Preencha o nome, descri√ß√£o e selecione uma imagem.");
                return null;
            }

            // O formato JSON de metadados ERC-721
            const metadata = {
                name: name,
                description: description,
                image: base64Image, // O Base64 da imagem j√° est√° aqui
                attributes: [] // Pode adicionar atributos aqui se quiser
            };

            // Converte o JSON em Data URI Base64
            const jsonString = JSON.stringify(metadata);
            const base64Metadata = btoa(jsonString);
            
            // Retorna a Data URI completa no formato esperado pelo contrato
            return `data:application/json;base64,${base64Metadata}`;
        }
        
        /**
         * Fun√ß√£o principal de Pr√©-visualiza√ß√£o
         */
        previewBtn.onclick = () => {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];

            if (!file) {
                updateStatus("üö® Por favor, selecione um arquivo de imagem.");
                return;
            }

            updateStatus("Carregando imagem e gerando Data URI...");

            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Image = event.target.result; // Data URI da imagem (ex: data:image/png;base64,...)
                
                // 1. Gera a Data URI completa do Metadado
                dataUriCache = generateDataURI(base64Image); 
                
                if (dataUriCache) {
                    // 2. Pr√©-visualiza a imagem (a Data URI da imagem pura)
                    nftPreview.src = base64Image;
                    nftPreview.style.display = 'block';
                    
                    updateStatus("‚úÖ Pr√©via gerada com sucesso! \n\nURI do Metadado (Ser√° enviada ao contrato): \n" + dataUriCache);
                }
            };
            reader.onerror = (error) => {
                updateStatus("‚ùå Erro ao ler o arquivo.");
                console.error(error);
            };
            reader.readAsDataURL(file); // L√™ o arquivo como Data URI
        };


        /**
         * 3. MINTAR NFT (Chamar a fun√ß√£o do contrato)
         */
        async function mintNFT() {
            if (!signer || !contract) {
                updateStatus("üö® Conecte a carteira primeiro.");
                return;
            }
            if (!dataUriCache) {
                updateStatus("üö® Gere a pr√©via do NFT antes de mintar.");
                return;
            }

            try {
                updateStatus("‚è≥ Enviando transa√ß√£o de mint... Confirme na MetaMask.");

                // Chama a fun√ß√£o mintNFT do seu contrato, passando a Data URI completa
                const tx = await contract.mintNFT(dataUriCache);
                
                updateStatus(`‚úÖ Transa√ß√£o enviada! Hash: ${tx.hash}\n\nEsperando confirma√ß√£o...`);

                // Espera a transa√ß√£o ser minerada
                await tx.wait();

                updateStatus(`üéâ NFT Mintado com Sucesso! \nToken URI: ${dataUriCache.substring(0, 100)}...\n\nVoc√™ pode encontrar seu NFT em um explorador de blocos!`);

            } catch (error) {
                updateStatus(`‚ùå Erro ao mintar: ${error.message.substring(0, 150)}... Veja o console para detalhes.`);
                console.error("Erro completo ao mintar:", error);
            }
        }

        // --- Event Listeners ---
        connectWalletBtn.addEventListener('click', connectWallet);
        mintBtn.addEventListener('click', mintNFT);

        function updateStatus(message) {
            statusDiv.textContent = message;
            console.log(message);
        }
        
    </script>
</body>
</html>
